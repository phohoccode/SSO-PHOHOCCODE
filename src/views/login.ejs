<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Đăng nhập</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  </head>

  <script>
    $(document).ready(function () {
      const username = $("#username");
      const password = $("#password");
      const btnLogin = $("#btn-login");
      //   const liveToast = $("#liveToast");
      const btnCloseToast = $("#btn-close-toast");
      const toastBody = $("#toast-body");
      const redirectURL = $("#redirectURL").val();
      const forgotPassword = $("#forgot-password");
      const btnChangePassword = $("#btn-submit-modal");
      const btnSendCode = $("#btn-send-code");
      const emailModal = $("#email-modal");
      const passwordModal = $("#password-modal");
      const newPasswordModal = $("#new-password-modal");
      const confirmCode = $("#confirmation-code");
      const btnLoginGoogle = $("#btn-login-google");
      const btnLoginFacebook = $("#btn-login-facebook");
      const btnLoginGithub = $("#btn-login-github");
      const btnLoginDiscord = $("#btn-login-discord");
      const modalForgotPassword = new bootstrap.Modal($("#modal"));
      const toast = new bootstrap.Toast($(".toast"), {
        animation: true,
        autohide: true,
      });

      function resetRemoveInvalid(element) {
        element.hasClass("is-invalid") && element.removeClass("is-invalid");
      }

      function showHideElement(element, classAdd, classRemove) {
        element.addClass(classAdd);
        element.addClass(classRemove);
      }

      function checkValidInputs() {
        let check = true;

        if (!username.val()) {
          username.addClass("is-invalid");
          check = false;
        }

        if (!password.val()) {
          password.addClass("is-invalid");
          check = false;
        }

        return check;
      }

      username.on("input", () => resetRemoveInvalid(username));
      password.on("input", () => resetRemoveInvalid(password));

      forgotPassword.on("click", function () {
        modalForgotPassword.show();
      });

      emailModal.on("input", () => resetRemoveInvalid(emailModal));
      newPasswordModal.on("input", () => resetRemoveInvalid(newPasswordModal));
      confirmCode.on("input", () => resetRemoveInvalid(confirmCode));

      btnSendCode.on("click", function () {
        if (!emailModal.val()) {
          emailModal.addClass("is-invalid");
          return;
        }

        btnSendCode.prop("disabled", true);

        const data = {
          email: emailModal.val(),
          type: "FORGOT-PASSWORD",
        };

        $.ajax({
          type: "POST",
          url: `${window.location.origin}/send-otp`,
          data: data,
          withCredentials: true,
          success: function (data) {
            toast.show();
            btnSendCode.prop("disabled", false);
            toastBody.text(data.EM);
          },
          error: function (request, status, error) {
            btnSendCode.prop("disabled", false);
            toastBody.text(error);
          },
        });
      });

      btnChangePassword.on("click", function () {
        let check = true;

        if (!emailModal.val()) {
          emailModal.addClass("is-invalid");
          check = false;
        }

        if (!newPasswordModal.val()) {
          newPasswordModal.addClass("is-invalid");
          check = false;
        }

        if (!confirmCode.val()) {
          confirmCode.addClass("is-invalid");
          check = false;
        }

        if (check) {
          const data = {
            email: emailModal.val(),
            password: newPasswordModal.val(),
            code: confirmCode.val(),
            type: "FORGOT-PASSWORD",
          };

          $.ajax({
            type: "POST",
            url: `${window.location.origin}/forgot-password`,
            data: data,
            withCredentials: true,
            success: function (data) {
              toast.show();
              btnSendCode.prop("disabled", false);
              toastBody.text(data.EM);

              if (+data.EC === 0) {
                window.location.reload();
              }
            },
            error: function (request, status, error) {
              btnSendCode.prop("disabled", false);
              toastBody.text(error);
            },
          });
        }
      });

      btnLogin.on("click", function () {
        const isCheckValid = checkValidInputs();

        if (isCheckValid) {
          const data = {
            username: username.val(),
            password: password.val(),
          };

          $.ajax({
            type: "POST",
            url: `${window.location.origin}/login`,
            data: data,
            withCredentials: true,
            success: function (data) {
              console.log(data);
              toast.show();
              window.location.href = `${redirectURL}/authenticate?ssoToken=${data.code}&type=LOCAL`;
            },
            error: function (request, status, error) {
              toast.show();
              toastBody.text(request.responseJSON.message);
            },
          });
        }
      });

      btnLoginGoogle.on("click", function () {
        window.location.href = "/auth/google";
      });

      btnLoginFacebook.on("click", function () {
        window.location.href = "/auth/facebook";
      });

      btnLoginGithub.on("click", function () {
        window.location.href = "/auth/github";
      });

      btnLoginDiscord.on("click", function () {
        window.location.href = "/auth/discord";
      });
    });
  </script>

  <body
    style="
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 24px;
    "
  >
    <input type="text" id="redirectURL" value="<%= redirectURL %>" hidden />
    <div style="max-width: 640px">
      <div class="row">
        <fieldset class="border rounded-3 p-3">
          <legend class="float-none w-auto px-3">Đăng nhập</legend>
          <form>
            <div class="row">
              <div class="mb-3 col-12">
                <label class="form-label">Email/Số điện thoại</label>
                <input id="username" type="username" class="form-control" />
              </div>
              <div class="mb-3 col-12">
                <label class="form-label">Mật khẩu</label>
                <input id="password" type="password" class="form-control" />
              </div>
              <span
                id="forgot-password"
                class="text-end mb-3"
                style="color: #0d6efd; cursor: pointer"
                >Quên mật khẩu?</span
              >
            </div>

            <button
              id="btn-login"
              type="button"
              class="btn btn-success w-100 mt-3"
            >
              Đăng nhập
            </button>

            <div class="text-center mt-5">
              <h6>Hoặc đăng nhập với</h6>
            </div>

            <div class="mt-3 d-flex flex-column gap-3">
              <button
                id="btn-login-facebook"
                type="button"
                class="btn w-100 btn-primary"
              >
                <span>Facebook</span>
                <i class="bi bi-facebook"></i>
              </button>
              <button
                style="border: 1px solid #eee"
                id="btn-login-google"
                type="button"
                class="btn w-100 btn-light"
              >
                <span>Google</span>
                <i class="bi bi-google"></i>
              </button>
              <button
                id="btn-login-github"
                type="button"
                class="btn w-100 btn-dark"
              >
                <span>Github</span>
                <i class="bi bi-github"></i>
              </button>
              <button
                style="background-color: #5865f2; color: #fff"
                id="btn-login-discord"
                type="button"
                class="btn w-100"
              >
                <span>Discord</span>
                <i class="bi bi-discord"></i>
              </button>
            </div>
            <hr />
            <div class="text-center">
              <span>Chưa có tài khoản? </span>
              <a href="/register" style="text-decoration: none">Đăng ký</a>
            </div>
          </form>
        </fieldset>
      </div>
    </div>

    <!-- Toast message -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 9999">
      <div
        id="liveToast"
        class="toast hide"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="toast-header">
          <strong class="me-auto">Thông báo!</strong>
          <small>Vừa xong</small>
          <button
            id="btn-close-toast"
            type="button"
            class="btn-close"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
        <div class="toast-body" id="toast-body"></div>
      </div>
    </div>

    <!-- Modal -->

    <div
      id="modal"
      class="modal fade"
      id="modal-forgot-password"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Quên mật khẩu</h5>
            <button
              id="btn-close-modal"
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3 col-12">
              <label class="form-label">Email</label>
              <input id="email-modal" type="text" class="form-control" />
            </div>
            <div class="mb-3 col-12">
              <label class="form-label">Mật khẩu mới</label>
              <input
                id="new-password-modal"
                type="password"
                class="form-control"
              />
            </div>
            <div class="row">
              <div class="mb-3 col-4">
                <label class="form-label">Mã xác nhận</label>
                <input
                  id="confirmation-code"
                  type="text"
                  class="form-control"
                  size="6"
                  maxlength="6"
                />
              </div>
              <div class="mb-3 col-4">
                <button
                  id="btn-send-code"
                  style="margin-top: 32px"
                  class="btn btn-success"
                  type="button"
                >
                  Gửi mã
                </button>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              id="btn-cancel-modal"
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Huỷ
            </button>
            <button
              id="btn-submit-modal"
              type="button"
              class="btn btn-primary"
              id="btn-change-password"
            >
              Xác nhận
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
